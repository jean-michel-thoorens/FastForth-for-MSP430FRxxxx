; macro called by SendSource.bat
; param1 = this macro
; param2 = file.4TH to send
; param3 = "/C" i.e. connect to current COMx
; param4 = "ECHO" | "NOECHO" | "HALF" | ""
; param5 = deviceID, see select.bat

connect param3

inputbox 'Send this file to the MSP430FR target:' ' ' param2

sendln 'CODE ?ID';                              CODE ?ID
sendln 'CMP #0,R14 0<> IF SUB &$1A04,R14 THEN'; CMP #0,TOS 0<> IF SUB &DEVICEID,TOS THEN
sendln 'COLON $1B EMIT $63 EMIT';               COLON $1B EMIT $63 EMIT     \ send 'ESC c'
sendln 'ABORT" DeviceID mismatch!" ';           ABORT" DeviceID mismatch!"
sendln '[DEFINED] STOP [IF] STOP [THEN]';       compile STOP if defined
sendln 'NOECHO ;';                              NOECHO ;

send param5 ' ?ID ' ;                           %deviceID% ?ID

strcompare param4 'NOECHO'
if result = 0 then
    setecho 0           ; no echo from Teraterm
    showtt 0
    uptime timestart ; starts chrono...
    sendfile inputstr 0
    goto end
endif

strcompare param4 'HALF'
if result = 0 then
    setecho 0
    showtt 0
    uptime timestart ; starts chrono...
    sendfile inputstr 0
    send #4
    setecho 1
    goto end
endif

; default mode = ECHO
    sendln 'ECHO'
    setecho 0       ; no echo from Teraterm
    showtt 0
    uptime timestart ; starts chrono...
    sendfile inputstr 0

:end

uptime timeend  ; stops chrono...

showtt 1

diff = timeend - timestart
sprintf2 resultat " %s download and execute: %d msec" param2 diff
messagebox resultat "teraterm.exe"

unlink
;end


